name: Deploy to Server

on:
  push:
    branches:
      - main  # Ou la branche que tu souhaites d√©ployer
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # V√©rifier si la cl√© SSH est bien d√©finie
      - name: V√©rification de la cl√© SSH
        run: |
          echo "üîç V√©rification de SSH_PRIVATE_KEY :"
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY is missing!"
            exit 1
          else
            echo "‚úÖ SSH_PRIVATE_KEY exists"
          fi

      # Cr√©er le dossier .ssh s'il n'existe pas
      - name: Create .ssh directory
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh  # S√©curiser le dossier

      # V√©rification de l'accessibilit√© du serveur
      - name: Check if SSH server is reachable
        run: |
          echo "üîç V√©rification de l'accessibilit√© du serveur..."
          if nc -zv 192.168.2.34 20; then
            echo "‚úÖ Serveur accessible, ajout √† known_hosts"
            ssh-keyscan -H 192.168.2.34 >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          else
            echo "‚ùå Serveur injoignable, √©chec du d√©ploiement"
            exit 1
          fi

      # Ajouter la cl√© priv√©e SSH
      - name: Add SSH private key
        run: |
          echo "üîç Ajout de la cl√© priv√©e SSH"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | sed 's/\r$//' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # S√©curiser la cl√© priv√©e
          # V√©rification : s'assurer que la cl√© priv√©e n'est pas vide
          if [ ! -s ~/.ssh/id_rsa ]; then
              echo "‚ùå SSH key is empty!"
              exit 1
          fi

      # Test de la connexion SSH
      - name: Test SSH connection
        run: |
          echo "üîç Test de la connexion SSH"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa webgrp04@192.168.2.34 "echo '‚úÖ SSH connection successful'"

      # Commande de d√©ploiement sur le serveur distant
      - name: Deploy Application
        run: |
          echo "üîç Lancement du d√©ploiement"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa webgrp04@192.168.2.34 << 'EOF'
            # Remplace ceci par tes propres commandes de d√©ploiement
            cd /path/to/application
            git pull origin main
            ./deploy.sh
          EOF
