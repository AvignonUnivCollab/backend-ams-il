name: Deploy to Server

on:
  push:
    branches:
      - main  # Ou la branche que tu souhaites d√©ployer

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # V√©rifier si la cl√© priv√©e SSH est d√©finie
      - name: Check if SSH_PRIVATE_KEY exists
        run: |
          echo "Testing if SSH_PRIVATE_KEY exists..."
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY is not set!"
            exit 1
          else
            echo "‚úÖ SSH_PRIVATE_KEY is set."
          fi

      # Cr√©er le dossier .ssh et configurer la cl√© SSH
      - name: Add SSH key and configure known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh  # S√©curiser le dossier .ssh

          echo "üîç SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}"

          # Ajouter la cl√© priv√©e SSH dans le fichier id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | sed 's/\r$//' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # S√©curiser la cl√© priv√©e

          # V√©rification si la cl√© priv√©e n'est pas vide
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå SSH key is empty!"
            exit 1
          fi

          # Ajouter la cl√© du serveur au fichier known_hosts
          ssh-keyscan -H 192.168.2.34 >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts  # Permettre la lecture du fichier known_hosts

          # V√©rification du contenu de known_hosts
          echo "üîç Contenu de known_hosts :"
          cat ~/.ssh/known_hosts

      # Tester la connexion SSH avec logs d√©taill√©s
      - name: Test SSH connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa user@192.168.2.34 "echo '‚úÖ SSH connection successful'"

      # D√©ployer ton application
      - name: Deploy application
        run: |
          # Remplacer cette commande par celle n√©cessaire pour ton d√©ploiement
          echo "üöÄ Deploying application to server..."
          ssh -i ~/.ssh/id_rsa user@192.168.2.34 'cd /path/to/your/app && git pull && ./deploy.sh'
